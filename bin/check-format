#!/usr/bin/env python
'''
Check the format of the files in the given directory. This script takes only
one argument, the directory to process. A recursive look-up will be done to
look for python files in the sub-directories and determine whether the files
have the correct format.
'''

import argparse
import io
import os
import re
import subprocess


def main(directory, file_type):
    '''
    Main function to execute.
    '''
    matched_files = []
    for root, _, files in os.walk(directory):
        for f in files:
            if file_type == 'python' and not f.endswith('.py'):
                continue
            matched_files.append(os.path.join(root, f))

    process = subprocess.Popen(['autopep8', '--diff'] + matched_files,
                               stdout=subprocess.PIPE,
                               stderr=subprocess.PIPE)

    stdout, stderr = process.communicate()

    if process.returncode < 0:
        raise RuntimeError('Call to autopep8 exited with error {}\nMessage:\n{}'.format(
            abs(returncode), stderr))

    if len(stdout):
        raise RuntimeError(
            f'Found differences for files in directory "{directory}" with file type "{file_type}"')


if __name__ == '__main__':

    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('directory', type=str,
                        help='Directory to look for files')
    parser.add_argument('file_type', type=str, choices=('python', 'all'),
                        help='File type to process')
    args = parser.parse_args()
    main(args.directory, args.file_type)
